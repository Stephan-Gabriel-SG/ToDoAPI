<!doctype html>
<html lang="en" class="has-navbar-fixed-top">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
    <link
      href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css"
      rel="stylesheet"
    />
    <title>TodoList</title>
  </head>
  <body>
    <div id="notificationArea" class="p-3"></div>
    <div id="root">
      <nav
        class="navbar has-shadow"
        role="navigation"
        aria-label="main navigation"
      >
        <div class="navbar-brand">
          <a class="navbar-item" href="/">
            <h1 class="title is-4">TodoList</h1>
          </a>
          <a
            role="button"
            class="navbar-burger"
            aria-label="menu"
            aria-expanded="false"
            data-target="navbarBasicExample"
          >
            <i class="bx bx-menu bx-sm"></i>
          </a>
        </div>

        <div class="navbar-menu">
          <div class="navbar-end">
            <a class="navbar-item" href="/">Accueil</a>
            <a class="navbar-item" href="/docs.html">Documentation</a>
          </div>
        </div>
      </nav>
      <div class="container">
        <div class="field has-addons">
          <p class="control has-icons-left is-expanded">
            <input
              id="search"
              type="text"
              class="input is-rounded"
              placeholder="Rechercher une t√¢che via mot cl√© titre ou description"
            />
            <span class="icon is-left">
              <i class="bx bx-search"></i>
            </span>
          </p>
          <p class="control">
            <button class="button is-info">Rechercher</button>
          </p>
        </div>
        <div class="buttons">
          <button class="button is-primary" onclick="toggleModal()">
            <i class="bx bx-plus"></i> Ajouter une t√¢che
          </button>
          <button class="button is-primary" onclick="toggleFilter()">
            <i class="bx bx-filter"></i> Filtrer les t√¢ches
          </button>
        </div>
        <div id="filters" class="filter box is-hidden">
          <h2 class="title is-5">Filtres</h2>

          <!-- Filtrer par priorit√© -->
          <div class="field">
            <label class="label">Priorit√©</label>
            <div class="control">
              <div class="select">
                <select id="priorityFilter">
                  <option value="">-- Choisir --</option>
                  <option value="high">Haute</option>
                  <option value="medium">Moyenne</option>
                  <option value="low">Basse</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Filtrer par tag -->
          <div class="field">
            <label class="label">Tag</label>
            <div class="control">
              <input
                class="input is-rounded"
                type="text"
                id="tagFilter"
                placeholder="Ex: travail"
              />
            </div>
          </div>

          <!-- Favoris -->
          <div class="field">
            <label class="checkbox">
              <input type="checkbox" id="favoriteFilter" />
              Favoris
            </label>
          </div>

          <!-- Compl√©t√©s -->
          <div class="field">
            <label class="checkbox">
              <input type="checkbox" id="completedFilter" />
              Compl√©t√©s
            </label>
          </div>

          <button class="button is-link" onclick="applyFilters()">
            Appliquer
          </button>
        </div>
        <!-- </div> -->

        <h1 class="title is-3">Listes des t√¢ches</h1>
        <div id="todos" class="columns is-multiline is-variable is-4"></div>
      </div>
    </div>
    <div id="todoModal" class="modal">
      <div class="modal-background"></div>
      <div class="modal-card">
        <header class="modal-card-head">
          <p class="modal-card-title">Cr√©er une nouvelle t√¢che</p>
          <button
            class="delete"
            aria-label="close"
            onclick="toggleModal()"
          ></button>
        </header>

        <form id="todoForm" onsubmit="submitTodo(event)">
          <section class="modal-card-body">
            <!-- Titre -->
            <div class="field">
              <label class="label"
                >Titre <span class="has-text-danger">*</span></label
              >
              <div class="control">
                <input
                  id="newTitle"
                  class="input"
                  type="text"
                  placeholder="Titre de la t√¢che"
                  required
                />
              </div>
            </div>

            <!-- Description -->
            <div class="field">
              <label class="label">Description</label>
              <div class="control">
                <textarea
                  id="newDescription"
                  class="textarea"
                  placeholder="Description..."
                ></textarea>
              </div>
            </div>

            <!-- Priorit√© -->
            <div class="field">
              <label class="label"
                >Priorit√© <span class="has-text-danger">*</span></label
              >
              <div class="control">
                <div class="select">
                  <select id="newPriority" required>
                    <option value="">-- Choisir --</option>
                    <option value="low">üü¢ Basse</option>
                    <option value="medium">üü† Moyenne</option>
                    <option value="high">üî¥ Haute</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Favori -->
            <div class="field">
              <label class="checkbox">
                <input type="checkbox" id="newFavorite" /> Marquer comme favori
              </label>
            </div>
          </section>

          <footer class="modal-card-foot">
            <div class="buttons">
              <button type="submit" class="button is-success">Cr√©er</button>
              <button type="button" class="button" onclick="toggleModal()">
                Annuler
              </button>
            </div>
          </footer>
        </form>
      </div>
    </div>
  </body>
  <script type="text/javascript" async="true">
    // Conversion de priorit√©
    const priorityConvertion = {
      high: 'Haute',
      medium: 'Moyenne',
      low: 'Basse',
    };
    // Formatage formatISODate
    function formatISODate(isoString) {
      const date = new Date(isoString);

      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0'); // les mois commencent √† 0
      const year = date.getFullYear();

      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');

      return `${day}-${month}-${year} ${hours}:${minutes}`;
    }

    // API REQUEST
    const api_url = 'http://localhost:3000/todos';

    // CREATE - Cr√©er un nouvel √©l√©ment
    async function createTodo(todoData) {
      try {
        const response = await fetch(api_url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Accept: 'application/json',
          },
          body: JSON.stringify(todoData),
        });

        if (!response.ok) {
          const errorDetails = await response.json();
          console.error(
            "D√©tails de l'erreur:",
            errorDetails.message.join(', '),
          );
          throw new Error(`${errorDetails.message.join(', ')}`);
        }

        return await response.json();
      } catch (error) {
        console.error('Erreur lors de la cr√©ation:', error);
        throw error;
      }
    }

    // READ - Lire tous les √©l√©ments
    async function getAllTodos() {
      try {
        const response = await fetch(api_url);

        if (!response.ok) {
          throw new Error(`Erreur HTTP: ${response.status}`);
        }

        return await response.json();
      } catch (error) {
        console.error('Erreur lors de la r√©cup√©ration des todos:', error);
        throw error;
      }
    }

    // READ - Lire un √©l√©ment sp√©cifique par ID
    async function getTodoById(id) {
      try {
        const response = await fetch(`${api_url}/${id}`);

        if (!response.ok) {
          throw new Error(`Erreur HTTP: ${response.status}`);
        }

        return await response.json();
      } catch (error) {
        console.error(`Erreur lors de la r√©cup√©ration du todo ${id}:`, error);
        throw error;
      }
    }

    // UPDATE - Mettre √† jour un √©l√©ment
    async function updateTodo(id, updatedData) {
      try {
        const response = await fetch(`${api_url}/${id}`, {
          method: 'PUT', // ou 'PATCH' selon votre API
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(updatedData),
        });

        if (!response.ok) {
          throw new Error(`Erreur HTTP: ${response.status}`);
        }

        return await response.json();
      } catch (error) {
        console.error(`Erreur lors de la mise √† jour du todo ${id}:`, error);
        throw error;
      }
    }

    // DELETE - Supprimer un √©l√©ment
    async function deleteTodo(id) {
      try {
        const response = await fetch(`${api_url}/${id}`, {
          method: 'DELETE',
        });

        if (!response.ok) {
          throw new Error(`Erreur HTTP: ${response.status}`);
        }

        // Certaines APIs ne retournent rien pour DELETE, d'autres retournent l'objet supprim√©
        return response.status === 204 ? null : await response.json();
      } catch (error) {
        console.error(`Erreur lors de la suppression du todo ${id}:`, error);
        throw error;
      }
    }

    /*************  ‚ú® Windsurf Command ‚≠ê  *************/
    /**
     * Affiche la liste des t√¢ches pass√©es en param√®tre
     * en tant que carte Bulma dans le conteneur HTML
     * d'id "todos"
     *
     * @param {todoEntry[]} todoList - La liste des t√¢ches √† afficher
     */
    /*******  cbd4a2e5-889a-4600-a6f3-a436bc4d1357  *******/
    function renderTodos(todoList) {
      const container = document.getElementById('todos');
      container.innerHTML = '';

      todoList.forEach((todo) => {
        const card = document.createElement('div');
        card.className = 'card mb-4';
        card.id = `todo-${todo.id}`;
        card.innerHTML = `
      <header class="card-header">
        <p class="card-header-title">
          <i class='bx bx-list-ul bx-sm' style="margin-right:8px;"></i>
          ${todo.title}
        </p>
        <div class="card-header-icon">
          ${todo.isFavorite ? "<i class='bx bxs-star' style='color: gold;'></i>" : ''}
        </div>
      </header>

      <div class="card-content">
        <div class="content">
          ${todo.description ? `<p><strong>Description:</strong> ${todo.description}</p>` : ''}
          <p><strong>Priorit√©:</strong> ${priorityIcon(todo.priority)} ${priorityConvertion[todo.priority]}</p>
          ${todo.tags?.length ? `<p><strong>Tags:</strong> ${todo.tags.map((tag) => `<span class="tag is-info">${tag}</span>`).join(' ')}</p>` : ''}
          <label class="checkbox mt-2">
            <input type="checkbox" ${todo.isCompleted ? 'checked' : ''}> Compl√©t√©e
          </label>
          <p class="is-size-7 mt-2 has-text-grey">Cr√©√©e le ${formatISODate(todo.createdAt)} ‚Ä¢ Modifi√©e le ${formatISODate(todo.updatedAt)}</p>
        </div>
      </div>

      <footer class="card-footer">
        <a href="#" class="card-footer-item has-text-info"><i class='bx bx-edit-alt'></i> Modifier</a>
        <a href="#" class="card-footer-item has-text-danger"><i class='bx bx-trash'></i> Supprimer</a>
      </footer>
    `;

        container.appendChild(card);
      });
    }

    // Fonction utilitaire pour afficher une ic√¥ne selon la priorit√©
    function priorityIcon(p) {
      switch (p) {
        case 'high':
          return 'üî¥';
        case 'medium':
          return 'üü†';
        case 'low':
          return 'üü¢';
        default:
          return '‚ö™';
      }
    }

    // Fonction utilitaire pour afficher une notification
    function showNotification(type, message, duration = 3000) {
      const area = document.getElementById('notificationArea');

      const notif = document.createElement('div');
      notif.className = `notification is-${type} is-light`;
      notif.style.zIndex = '9999';
      notif.innerHTML = `
    <button class="delete" onclick="this.parentElement.remove()"></button>
    ${message}
  `;

      area.appendChild(notif);

      setTimeout(() => {
        notif.remove();
      }, duration);
    }

    // Interaction avec les boutons
    function toggleModal() {
      document.getElementById('todoModal').classList.toggle('is-active');
    }
    function toggleFilter() {
      document.getElementById('filters').classList.toggle('is-hidden');
    }

    function submitTodo(event) {
      event.preventDefault();

      const description = document.getElementById('newDescription').value;
      const newTodo = {
        title: document.getElementById('newTitle').value,
        priority: document.getElementById('newPriority').value,
        isFavorite: document.getElementById('newFavorite').checked,
      };

      if (description.length > 0) {
        newTodo.description = description;
      }

      createTodo(newTodo)
        .then((response) => {
          if (response.success) {
            showNotification('success', response.message);
            toggleModal();
            document.getElementById('todoForm').reset();
            todoList.push(response.data);
            renderTodos(todoList);
          } else {
            showNotification('danger', response.message);
          }
        })
        .catch((error) => {
          showNotification('danger', error);
        });
    }

    // Initialisation de la liste des t√¢ches
    let todoList = [];

    getAllTodos().then((response) => {
      if (response.success) {
        todoList = response.data;
        renderTodos(todoList);
      }
    });
  </script>
</html>
